<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <title>美福尔管理平台</title>
</head>
<script id="product-template" type="text/x-jsrender">
    <div class="product">
     <input name="product-no" value="{{:no}}" hidden>
        <div class="col-lg-4">
            <div data-provides="fileupload" class="fileupload fileupload-exists" data-url="{{:url}}">
                <input type="hidden" value="" name="">
                <div style="width: 220px; height: 164px;" class="fileupload-new thumbnail">
                    <img src="http://www.placehold.it/220x164/EFEFEF/AAAAAA&amp;text=产品图片">
                </div>
                <div style="max-width: 220px; max-height: 164px; line-height: 10px;" class="fileupload-preview fileupload-exists thumbnail">
                    <img style="max-height: 164px;" src="{{:url}}">
                </div>
                <div style="position: absolute; bottom: 0; left: 159px;">
                    <span class="btn btn-primary btn-file btn-xs">
                        <span class="fileupload-new"><i class="icon-picture"></i> 选择图片</span>
                        <span class="fileupload-exists"><i class="icon-undo"></i> 更改图片</span>
                        <input type="file" name="product-img" class="default" data-no="{{:no}}">
                    </span>
                </div>
            </div>
        </div>
    </div>
</script>
<body>
<div class="wrapper">
    <div class="row">
        <div class="col-lg-12">
            <div class="panel">
                <header class="panel-heading">
                    新增产品
                    <button class="close close-sm" type="button" title="返回" onclick="loadMainPage('pages/production/list.html')">
                        <i class="icon-reply"></i>
                    </button>
                </header>
                <div class="panel-body">
                    <form id="product-form" class="form-horizontal tasi-form" enctype='multipart/form-data'>
                        <input id="pid" hidden>
                        <div class="form-group">
                            <label class="col-sm-2 col-sm-2 control-label">相册名称</label>
                            <div class="col-sm-9">
                                <input id="name" name="name" type="text" class="form-control">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 col-sm-2 control-label">描述</label>
                            <div class="col-sm-9">
                                <input id="desc" name="desc" type="text" class="form-control">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">产品图片</label>
                            <div id="products" class="col-sm-9">
                                <input name="product-no" hidden>
                                <div class="product">
                                    <div class="col-lg-4">
                                        <div class="fileupload fileupload-new" data-provides="fileupload">
                                            <div class="fileupload-new thumbnail" style="width: 220px; height: 164px;">
                                                <img src="http://www.placehold.it/220x164/EFEFEF/AAAAAA&amp;text=产品图片">
                                            </div>
                                            <div class="fileupload-preview fileupload-exists thumbnail"
                                                 style="max-width: 220px; max-height: 164px; line-height: 20px;"></div>
                                            <div style="position: absolute; bottom: -15px;">
                                                <span class="btn btn-primary btn-file btn-xs">
                                                    <span class="fileupload-new"><i class="icon-picture"></i> 选择图片</span>
                                                    <span class="fileupload-exists"><i class="icon-undo"></i> 更改图片</span>
                                                    <input type="file" class="default" name="product-img">
                                                </span>
                                                <a href="javascript:;" onclick="delPresent(this)" title="删除">
                                                    <i class="icon-remove-sign"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div id="plus-btn" class="present-plus" onclick="addPresent()">
                                    <span><i class="icon-plus"></i> 添加产品</span>
                                </div>
                            </div>
                        </div>
                        <div class="form-group pull-right" style="padding: 0 15px;">
                            <button class="btn btn-success" type="button" onclick="addProduct()">保存</button>
                            <button class="btn btn-warning" type="button" onclick="loadMainPage('pages/production/new.html')">取消</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    //添加产品
    var newPresentHtml = '<div class="product">' + $('.product').html() + '</div>';
    function addPresent() {
        $('#plus-btn').before(newPresentHtml);
    }

    //删除产品
    function delPresent(v) {
        $(v).parents('.product').remove();
    }


    //保存产品
    function addProduct() {
        //输入校验
        var flag = true;
        var name = $('#name').val();
        var desc = $('#desc').val();
        if (!name) {
            yeshidenotify('warning', 'top center', '请输入产品名称！', '提示将在2秒内关闭', 2000);
            flag = false;
            return false;
        }
        $('#products .product').each(function () {
            if ($(this).find('div.fileupload').hasClass('fileupload-new')) {
                yeshidenotify('warning', 'top center', '请上传产品图片！', '提示将在2秒内关闭', 2000);
                flag = false;
                return false;
            }
        });

        var pid = $('#pid').val();
        var url = 'api/products/';
        var data = {};
        if (pid) {
            url += pid;
            var goods = [];
            $('#products .product').each(function () {
                var good = {
                    no: $(this).find('input[name="product-no"]').val(),
                    preUrl: $(this).find('.fileupload').attr('data-url'),
                    state: $(this).find('.fileupload').attr('data-state'),
                };

                goods.push(good);
            });
            data = {imgs: goods};
        }

        //表单提交
        if (flag) {
            $('#product-form').ajaxSubmit({
                url: url,
                type: 'post',
                data: data,
                dataType: 'json',
                success: function (rm) {
                    if (rm.code == 1) {
                        yeshidenotify('success', 'top center', '保存成功！', '提示将在2秒内关闭', 2000);
                        loadMainPage('pages/production/list.html');
                    } else {
                        yeshidenotify('error', 'top center', '保存失败！', '提示将在2秒内关闭', 2000);
                    }
                }
            });
        }
    }
</script>
</body>
</html>
